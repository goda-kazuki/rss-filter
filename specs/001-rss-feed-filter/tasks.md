---

description: "RSSフィードフィルタリング機能の実装タスク"
---

# タスク: RSSフィードフィルタリング

**入力**: `/specs/001-rss-feed-filter/` の設計ドキュメント
**前提条件**: plan.md, spec.md, research.md, data-model.md, contracts/

**テスト**: 機能仕様に従い、テストはオプションであり、この実装計画には含まれていません。

**構成**: タスクはユーザーストーリーごとにグループ化され、各ストーリーの独立した実装とテストを可能にします。

## 形式: `[ID] [P?] [Story] 説明`

- **[P]**: 並列実行可能（異なるファイル、依存関係なし）
- **[Story]**: このタスクが属するユーザーストーリー（例: US1, US2, US3）
- 説明には正確なファイルパスを含める

## パス規約

- **単一プロジェクト**: リポジトリルートに `src/`, `tests/`
- パスは plan.md で定義された構造に従う

---

## フェーズ1: セットアップ（共通インフラ）

**目的**: プロジェクト初期化と基本構造

- [ ] T001 plan.md に従って src/, tests/ ディレクトリのプロジェクト構造を作成
- [ ] T002 package.json で TypeScript プロジェクトを初期化（typescript 5.x, node 20.x）
- [ ] T003 [P] 依存関係をインストール: fast-xml-parser, he（HTMLエンティティデコード用）
- [ ] T004 [P] 開発依存関係をインストール: vitest, esbuild, @types/node
- [ ] T005 [P] strict モード有効で tsconfig.json を設定
- [ ] T006 [P] constitution.md の要件に従って ESLint と Prettier を設定
- [ ] T007 [P] build.config.ts で Lambda バンドル用の esbuild 設定をセットアップ
- [ ] T008 [P] ユニットテスト用の vitest.config.ts を作成

---

## フェーズ2: 基盤（ブロッキング前提条件）

**目的**: すべてのユーザーストーリーを実装する前に完了しなければならないコアインフラ

**⚠️ 重要**: このフェーズが完了するまで、ユーザーストーリーの作業を開始できません

- [ ] T009 src/lib/errors.ts でエラー型を作成（FeedFetchError, ParseError, FilterValidationError, RegexTimeoutError）
- [ ] T010 [P] data-model.md に従って src/models/feed.ts に RSSFeed インターフェースを作成
- [ ] T011 [P] data-model.md に従って src/models/feed.ts に FeedItem インターフェースを作成
- [ ] T012 [P] data-model.md に従って src/models/filter.ts に FilterCriteria 型（KeywordFilter, RegexFilter）を作成
- [ ] T013 [P] data-model.md に従って src/models/filter.ts に FilterResult インターフェースを作成
- [ ] T014 fast-xml-parser を使用して URL から RSS を取得する feed-fetcher サービスを src/services/feed-fetcher.ts に実装
- [ ] T015 he パッケージを使用して src/services/html-decoder.ts に HTML エンティティデコーダーを実装
- [ ] T016 クエリパラメータ解析を含む Lambda ハンドラーエントリーポイントを src/handlers/lambda.ts に作成
- [ ] T017 src/handlers/lambda.ts にクエリパラメータ（feedUrl, type, pattern）の入力検証を追加
- [ ] T018 src/handlers/lambda.ts にエラーから HTTP ステータスコード（400/500）へのマッピングを追加

**チェックポイント**: 基盤準備完了 - ユーザーストーリーの実装を並行して開始可能

---

## フェーズ3: ユーザーストーリー1 - 基本的なキーワードフィルタリング (優先度: P1) 🎯 MVP

**目標**: ユーザーがシンプルなキーワードでRSSフィードアイテムをフィルタリングできる（大文字小文字を区別しない部分一致）

**独立テスト**: RSSフィードURLと「ニュース」などのキーワードを提供し、タイトルまたは説明に「ニュース」が含まれるアイテム（大文字小文字を区別しない）のみが表示されることを確認

### ユーザーストーリー1の実装

- [ ] T019 [US1] 大文字小文字を区別しないマッチングロジックを持つキーワードフィルタストラテジーを src/services/feed-filter.ts に作成
- [ ] T020 [US1] FeedItem 配列をフィルタリングする applyKeywordFilter 関数を src/services/feed-filter.ts に実装
- [ ] T021 [US1] タイトルと説明の両方のフィールドを検索するキーワードフィルタロジックを追加
- [ ] T022 [US1] src/handlers/lambda.ts の Lambda ハンドラーにキーワードフィルタを統合
- [ ] T023 [US1] 元の形式を保持する RSS/Atom XML レスポンス生成を src/handlers/lambda.ts に実装
- [ ] T024 [US1] pattern が非空文字列であることを確認する検証を追加
- [ ] T025 [US1] 空の結果（マッチなし）を処理し、空の channel/feed XML を返す
- [ ] T026 [US1] src/handlers/lambda.ts にキーワードフィルタ操作のロギングを追加

**チェックポイント**: この時点で、ユーザーストーリー1は完全に機能し、独立してテスト可能

---

## フェーズ4: ユーザーストーリー2 - 正規表現フィルタリング (優先度: P2)

**目標**: 高度なユーザーが正規表現を使用して複雑なマッチングパターンを作成できる

**独立テスト**: 「^\[News\]」のような正規表現パターンを提供し、「[News]」で始まるタイトルのアイテムのみがマッチすることを確認

### ユーザーストーリー2の実装

- [ ] T027 [US2] 正規表現コンパイルと検証を含む正規表現フィルタストラテジーを src/services/feed-filter.ts に作成
- [ ] T028 [US2] FeedItem 配列をフィルタリングする applyRegexFilter 関数を src/services/feed-filter.ts に実装
- [ ] T029 [US2] 無効なパターンに対して try-catch で正規表現パターン検証を src/services/feed-filter.ts に追加
- [ ] T030 [US2] AbortController を使用して正規表現タイムアウト機構（2000ms）を src/services/feed-filter.ts に実装
- [ ] T031 [US2] タイトルと説明の両方のフィールドを検索する正規表現フィルタロジックを追加
- [ ] T032 [US2] src/handlers/lambda.ts の Lambda ハンドラーに正規表現フィルタを統合
- [ ] T033 [US2] 無効な正規表現パターンに対する FilterValidationError を 400 エラーレスポンスで処理
- [ ] T034 [US2] 複雑なパターンに対する RegexTimeoutError を 500 エラーレスポンスで処理
- [ ] T035 [US2] src/handlers/lambda.ts に正規表現フィルタ操作のロギングを追加

**チェックポイント**: この時点で、ユーザーストーリー1と2の両方が独立して動作する

---

## フェーズ5: ユーザーストーリー3 - フィルタモード選択 (優先度: P3)

**目標**: ユーザーがキーワードと正規表現フィルタリングモードを簡単に切り替えられる

**独立テスト**: キーワードモードで「test.*data」を入力し（文字通りマッチ）、次に正規表現モードに切り替えて（パターンマッチ）、結果が適切に変更されることを確認

### ユーザーストーリー3の実装

- [ ] T036 [US3] FilterCriteria ユニオン型を受け入れる統一フィルタ関数を src/services/feed-filter.ts に作成
- [ ] T037 [US3] src/services/feed-filter.ts にフィルタタイプ判別ロジック（keyword vs regex）を実装
- [ ] T038 [US3] type パラメータに基づいて適切なフィルタにルーティングする Lambda ハンドラーを更新
- [ ] T039 [US3] type パラメータが 'keyword' または 'regex' であることを確認する検証を追加
- [ ] T040 [US3] 無効な type パラメータを 400 エラーレスポンスで処理
- [ ] T041 [US3] tests/integration/lambda.test.ts にモード切り替え動作を示す統合テストを追加

**チェックポイント**: すべてのユーザーストーリーが独立して機能する

---

## フェーズ6: 仕上げと横断的関心事

**目的**: 複数のユーザーストーリーに影響する改善

- [ ] T042 [P] tests/unit/feed-fetcher.test.ts に feed-fetcher の包括的なユニットテストを追加
- [ ] T043 [P] tests/unit/feed-filter.test.ts に feed-filter の包括的なユニットテストを追加
- [ ] T044 [P] tests/unit/html-decoder.test.ts に html-decoder の包括的なユニットテストを追加
- [ ] T045 [P] tests/integration/lambda.test.ts に Lambda ハンドラーの統合テストを追加
- [ ] T046 [P] デプロイ手順と使用例で README.md を更新
- [ ] T047 [P] パフォーマンス監視ログを追加（フィルタ操作ごとの実行時間）
- [ ] T048 quickstart.md のシナリオに対して検証（4つの例すべてが動作する必要がある）
- [ ] T049 [P] 明確性と保守性のためのコードレビューとリファクタリング
- [ ] T050 [P] constitution.md 準拠の最終チェック（Simplicity, Type Safety, Error Handling, Stateless）

---

## 依存関係と実行順序

### フェーズの依存関係

- **セットアップ（フェーズ1）**: 依存関係なし - すぐに開始可能
- **基盤（フェーズ2）**: セットアップの完了に依存 - すべてのユーザーストーリーをブロック
- **ユーザーストーリー（フェーズ3-5）**: すべて基盤フェーズの完了に依存
  - その後、ユーザーストーリーは並行して進行可能（人員がいる場合）
  - または優先順位順に順次実行（P1 → P2 → P3）
- **仕上げ（フェーズ6）**: すべての希望するユーザーストーリーが完了していることに依存

### ユーザーストーリーの依存関係

- **ユーザーストーリー1（P1）**: 基盤（フェーズ2）後に開始可能 - 他のストーリーに依存しない
- **ユーザーストーリー2（P2）**: 基盤（フェーズ2）後に開始可能 - US1に依存しないが同じ基盤インフラを使用
- **ユーザーストーリー3（P3）**: 基盤（フェーズ2）後に開始可能 - US1とUS2を統合するが独立してテスト可能

### 各ユーザーストーリー内

- モデル → サービス → ハンドラーの順
- コア実装 → 統合の順
- 検証 → エラー処理の順
- ストーリー完了 → 次の優先度に移行

### 並列実行の機会

- セットアップで [P] マークされたすべてのタスクは並列実行可能（T003-T008）
- 基盤で [P] マークされたすべてのモデル作成タスクは並列実行可能（T010-T013）
- 基盤フェーズ完了後、すべてのユーザーストーリーを並行開始可能（チーム能力が許せば）
- [P] マークされたすべてのユニットテストタスクは並列実行可能（T042-T045）
- 異なるユーザーストーリーは異なるチームメンバーが並行作業可能

---

## 並列実行の例: ユーザーストーリー1

```bash
# 基盤フェーズ完了後、ユーザーストーリー1のタスクを開始:
# チームに能力があれば、これらは並列実行可能:
タスク T019: "src/services/feed-filter.ts にキーワードフィルタストラテジーを作成"
タスク T024: "pattern が非空文字列であることを確認する検証を追加"

# これらは順次実行が必要:
タスク T019 → タスク T020 → タスク T022 → タスク T023（前の実装に依存）
```

---

## 並列実行の例: 仕上げフェーズ

```bash
# 実装完了後、すべてのユニットテストを一緒に開始:
タスク T042: "feed-fetcher のユニットテストを追加"
タスク T043: "feed-filter のユニットテストを追加"  
タスク T044: "html-decoder のユニットテストを追加"
タスク T045: "Lambda ハンドラーの統合テストを追加"

# ドキュメントとコードクリーンアップを並列実行:
タスク T046: "README.md を更新"
タスク T049: "コードレビューとリファクタリング"
```

---

## 実装戦略

### MVP優先（ユーザーストーリー1のみ）

1. フェーズ1完了: セットアップ（T001-T008）
2. フェーズ2完了: 基盤（T009-T018）- 重要 - すべてのストーリーをブロック
3. フェーズ3完了: ユーザーストーリー1（T019-T026）
4. **停止して検証**: quickstart.md の例1を使用してユーザーストーリー1を独立してテスト
5. 準備ができたらデプロイ/デモ

### 段階的デリバリー

1. セットアップ + 基盤を完了 → 基盤準備完了
2. ユーザーストーリー1を追加 → 独立してテスト → デプロイ/デモ（MVP！）
   - FR-003, SC-001, SC-002 を検証
3. ユーザーストーリー2を追加 → 独立してテスト → デプロイ/デモ
   - FR-004, FR-005, SC-003, SC-008 を検証
4. ユーザーストーリー3を追加 → 独立してテスト → デプロイ/デモ
   - FR-006, SC-004 を検証
5. 各ストーリーが以前のストーリーを壊すことなく価値を追加

### 並列チーム戦略

複数の開発者がいる場合:

1. チームで一緒にセットアップ + 基盤を完了（T001-T018）
2. 基盤完了後:
   - 開発者A: ユーザーストーリー1（T019-T026）
   - 開発者B: ユーザーストーリー2（T027-T035）
   - 開発者C: ユーザーストーリー3（T036-T041）
3. ストーリーが完了し、独立して統合

---

## 実装ノート

### 主要な設計パターン

1. **Strategy Pattern**: keyword/regex 判別を持つ FilterCriteria ユニオン型
2. **Result Type Pattern**: 明示的なエラー処理のためのカスタムエラー型
3. **Pure Functions**: すべてのフィルタ操作はステートレスで副作用なし
4. **Early Return**: パフォーマンスのためタイトルマッチ時は説明チェックをスキップ

### パフォーマンス目標

- **1000件**: 2秒以内にフィルタリング完了（SC-001）
- **5000件**: 5秒以内にフィルタリング完了（SC-006）
- **正規表現タイムアウト**: 最大実行時間 2000ms
- **Lambda メモリ**: 1GB 推奨
- **Lambda タイムアウト**: 最大 30秒

### ファイル構成まとめ

```text
src/
├── models/
│   ├── feed.ts          # RSSFeed, FeedItem インターフェース (T010, T011)
│   └── filter.ts        # FilterCriteria, FilterResult 型 (T012, T013)
├── services/
│   ├── feed-fetcher.ts  # fast-xml-parser による RSS取得と解析 (T014)
│   ├── feed-filter.ts   # キーワードと正規表現フィルタリングロジック (T019-T041)
│   └── html-decoder.ts  # he による HTML エンティティデコード (T015)
├── handlers/
│   └── lambda.ts        # Lambda エントリーポイントとリクエスト処理 (T016-T018)
└── lib/
    └── errors.ts        # カスタムエラー型 (T009)

tests/
├── unit/
│   ├── feed-fetcher.test.ts  # (T042)
│   ├── feed-filter.test.ts   # (T043)
│   └── html-decoder.test.ts  # (T044)
└── integration/
    └── lambda.test.ts         # (T045)
```

### 憲章準拠チェックポイント

- **Simplicity First**: 最小限の依存関係（fast-xml-parser, he, esbuild, vitest のみ）
- **Type Safety**: TypeScript strict モード、any 型なし、明示的な関数シグネチャ
- **Error Handling**: Lambda 境界での明示的な処理を持つカスタムエラー型
- **Stateless Design**: リクエスト間で共有状態なし、純粋関数アプローチ

---

## ノート

- [P] タスク = 異なるファイル、依存関係なし
- [Story] ラベルはトレーサビリティのためタスクを特定のユーザーストーリーにマッピング
- 各ユーザーストーリーは独立して完了およびテスト可能
- 機能仕様に従い、テストはオプション（明示的に要求されていない）
- 各タスクまたは論理的なグループの後にコミット
- 任意のチェックポイントで停止してストーリーを独立して検証
- 避けるべき: 曖昧なタスク、同じファイルの競合、独立性を壊すストーリー間の依存関係

---

## まとめ

**総タスク数**: 6フェーズにわたる50タスク

**ユーザーストーリーごとのタスク数**:
- セットアップ: 8タスク
- 基盤: 10タスク（すべてのストーリーをブロック）
- ユーザーストーリー1（P1）: 8タスク - MVP範囲
- ユーザーストーリー2（P2）: 9タスク
- ユーザーストーリー3（P3）: 6タスク
- 仕上げ: 9タスク

**特定された並列実行の機会**:
- フェーズ1: 6つの並列タスク（T003-T008）
- フェーズ2: 4つの並列モデル定義（T010-T013）
- フェーズ6: 5つの並列テスト/ドキュメントタスク（T042-T047）

**独立テスト基準**:
- US1: キーワードフィルタは一致するアイテムのみを返す（大文字小文字を区別しない）
- US2: 正規表現フィルタはパターンを検証し、タイムアウトを正しく処理
- US3: フィルタタイプの切り替えで同じパターンに対して適切な結果を生成

**推奨MVP範囲**: フェーズ1 + フェーズ2 + フェーズ3（ユーザーストーリー1のみ）
- これによりコアキーワードフィルタリング機能を提供
- quickstart.md の例1を使用して検証可能
- 基本ユースケースの最小実行可能製品を表す

**形式検証**: ✅ すべてのタスクはチェックリスト形式に従う（チェックボックス、ID、ラベル、ファイルパス）
